# Интеграция с Битрикс24 - Обработчик вебхуков

Система для обработки вебхуков от Битрикс24 и синхронизации данных с личным кабинетом клиента.

## Структура проекта

```
src/
├── config/
│   └── bitrix24.php          # Конфигурация интеграции
├── classes/
│   ├── Logger.php            # Класс логирования
│   ├── Bitrix24API.php       # API клиент для Битрикс24
│   └── LKAPI.php             # API клиент для личного кабинета
├── webhooks/
│   └── bitrix24.php          # Основной обработчик вебхуков
├── examples.php              # Примеры обработки событий
└── logs/                     # Директория для логов
```

## Настройка

### 1. Переменные окружения (.env)

Создайте файл `.env` на основе шаблона:

```bash
cp .env.example .env
```

Заполните реальные значения в `.env`:

```bash
# Настройки Битрикс24
BITRIX24_WEBHOOK_URL=https://your-domain.bitrix24.ru/rest/1/your-webhook-token/
BITRIX24_WEBHOOK_SECRET=your-webhook-secret

# Настройки личного кабинета
LK_API_URL=https://your-lk-domain.com/api/
LK_API_KEY=your-lk-api-key
```

### 2. Автоматическая настройка

Запустите скрипт установки:

```bash
install.bat
```

Он автоматически создаст `.env` файл из шаблона `.env.example`.

### 3. Маппинг полей

Настройте соответствие полей Битрикс24 и личного кабинета:

```php
'field_mapping' => [
    'contact' => [
        'lk_client_field' => 'UF_CRM_CONTACT_LK_CLIENT',
        'email' => 'EMAIL',
        'phone' => 'PHONE',
        // ...
    ],
],
```

## Настройка вебхуков в Битрикс24

### 1. Перейдите в настройки Битрикс24
`Настройки > Интеграции > Вебхуки`

### 2. Создайте входящий вебхук
- **URL обработчика**: `https://your-domain.com/src/webhooks/bitrix24.php`
- **Секрет**: настройте если требуется дополнительная валидация

### 3. Выберите события для отслеживания
```
☑ ONCRMCONTACTUPDATE    - Изменение контакта
☑ ONCRMCONTACTADD       - Создание контакта
☑ ONCRMCOMPANYUPDATE    - Изменение компании
☑ ONCRMDEALUPDATE       - Изменение сделки
☑ ONCRM_DYNAMIC_ITEM_UPDATE - Изменение смарт-процесса
```

## Логика обработки событий

### Создание/удаление ЛК (7,5% зависимости)

1. **Изменение поля "ЛК клиента" в контакте**
   - Если поле установлено → создать личный кабинет
   - Если поле снято → деактивировать личный кабинет

2. **Webhook**: `ONCRMCONTACTUPDATE`
3. **Действие**: Вызов API личного кабинета для создания/обновления

### Синхронизация данных (15% зависимости)

1. **Изменение контакта**: синхронизация email, телефона, имени
2. **Изменение компании**: синхронизация данных организации
3. **Изменение проектов**: обновление статусов и данных проектов

## Примеры использования

### Запуск обработчика

```bash
# Установка прав доступа
chmod 755 src/webhooks/bitrix24.php

# Тестирование (через веб-сервер)
curl -X POST https://your-domain.com/src/webhooks/bitrix24.php \
  -H "Content-Type: application/json" \
  -d @test-webhook.json
```

### Тестовый webhook запрос

```json
{
  "event": "ONCRMCONTACTUPDATE",
  "data": {
    "FIELDS": {
      "ID": "12345",
      "NAME": "Иван",
      "LAST_NAME": "Петров",
      "EMAIL": [{"VALUE": "ivan@example.com"}],
      "UF_CRM_CONTACT_LK_CLIENT": "Y"
    }
  }
}
```

## Логирование

Логи записываются в `src/logs/bitrix24_webhooks.log`:

```
[2025-01-18 14:30:00] INFO: Received webhook request | method: POST
[2025-01-18 14:30:01] INFO: Webhook data received | event: ONCRMCONTACTUPDATE
[2025-01-18 14:30:02] INFO: Creating new LK for contact | contact_id: 12345
```

## Мониторинг и отладка

### Проверка работы

1. **Логи**: проверяйте `src/logs/bitrix24_webhooks.log`
2. **HTTP статус**: 200 - успех, 400 - ошибка валидации, 500 - ошибка обработки

### Отладка

```php
// Включить подробное логирование
$config['logging']['level'] = 'DEBUG';

// Запустить примеры
require_once 'src/examples.php';
```

## Безопасность

- **Переменные окружения**: Все секреты хранятся в `.env` файле (не коммитится в git)
- **Валидация запросов**: Проверка User-Agent, Content-Type, JSON формат
- **Логирование**: IP-адреса, все действия фиксируются
- **API ключи**: Валидация ключей для запросов к личному кабинету
- **Gitignore**: `.env` файлы автоматически исключаются из репозитория

### Важно!
- Никогда не коммитьте `.env` файл в репозиторий
- Используйте разные ключи для разработки и продакшена
- Регулярно меняйте API ключи

## Расширение функционала

### Добавление новых событий

1. Добавьте обработчик в `processEvent()` в `bitrix24.php`
2. Настройте соответствующий API метод в `Bitrix24API.php`
3. Добавьте маппинг в конфигурацию

### Кастомная логика

Для специфической бизнес-логики модифицируйте:
- `handleContactUpdate()` - обработка контактов
- `handleCompanyUpdate()` - обработка компаний
- `handleSmartProcessUpdate()` - обработка проектов

## Производительность

- **Повторные попытки**: до 3 попыток с экспоненциальной задержкой
- **Таймауты**: 30 секунд на API запросы
- **Ротация логов**: автоматическая при достижении 10MB

## Troubleshooting

### Проблема: Webhook не приходит
- Проверьте URL в настройках Битрикс24
- Убедитесь, что сервер доступен по HTTPS
- Проверьте логи веб-сервера

### Проблема: Ошибка валидации
- Проверьте User-Agent заголовок
- Убедитесь в правильном Content-Type
- Проверьте JSON формат тела запроса

### Проблема: API ошибки
- Проверьте корректность webhook URL в конфиге
- Убедитесь в валидности API токена Битрикс24
- Проверьте логи на ошибки подключения

