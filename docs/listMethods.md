# Методы получения полей типа списка из Bitrix24

Данные методы предназначены для получения полей типа списка (enum, list) из различных сущностей Bitrix24 и их значений. Используются для построения выпадающих списков в формах.

## Общее назначение

Все три метода получают поля типа списка из Bitrix24 и возвращают их значения в структурированном формате. Они фильтруют поля по типам (`enum`, `enumeration`, `list`, `crm_status`, `crm_category`) и извлекают их значения из ответа API.

## 1. getSmartProcessListFields

### Описание
Получение полей типа списка смарт-процесса для проекта.

### Сигнатура
```php
public function getSmartProcessListFields($entityTypeId = null)
```

### Параметры
- `$entityTypeId` (int|null, опциональный) - ID смарт-процесса. Если не указан, берется из конфига (`$this->config['bitrix24']['smart_process_id']`)

### Возвращаемое значение
- `array|false` - Массив с полями типа списка и их значениями или `false` при ошибке

### Используемый API метод
- `crm.item.fields` - для получения всех полей элемента смарт-процесса

### Особенности
- Если `entityTypeId` не указан, метод берет значение из конфигурации
- Если значения не найдены в ответе API, для enum-полей выполняется дополнительный вызов `crm.enum.fields`
- Поддерживает все типы списков: `enum`, `enumeration`, `list`, `crm_status`, `crm_category`
- Включает детальное логирование для отладки

### Формат возвращаемых данных
```php
[
  'field_id' => [
    'name' => 'Название поля',
    'type' => 'enum',
    'values' => [
      'ID' => 'Название значения',
      ...
    ]
  ],
  ...
]
```

## 2. getContactListFields

### Описание
Получение полей типа списка контакта.

### Сигнатура
```php
public function getContactListFields()
```

### Параметры
- Нет параметров

### Возвращаемое значение
- `array|false` - Массив с полями типа списка и их значениями или `false` при ошибке

### Используемый API метод
- `crm.contact.fields` - для получения всех полей контакта (включая пользовательские поля)

### Особенности
- Значения enum-полей должны быть в ответе `crm.contact.fields`
- Дополнительный вызов `crm.enum.fields` не требуется, так как он работает только для смарт-процессов
- Возвращает только поля с непустыми значениями
- Включает детальное логирование для отладки

### Формат возвращаемых данных
```php
[
  'field_id' => [
    'name' => 'Название поля',
    'type' => 'enum',
    'values' => [
      'ID' => 'Название значения',
      ...
    ]
  ],
  ...
]
```

## 3. getCompanyListFields

### Описание
Получение полей типа списка компании.

### Сигнатура
```php
public function getCompanyListFields()
```

### Параметры
- Нет параметров

### Возвращаемое значение
- `array|false` - Массив с полями типа списка и их значениями или `false` при ошибке

### Используемый API метод
- `crm.company.fields` - для получения всех полей компании (включая пользовательские поля)

### Особенности
- Значения enum-полей должны быть в ответе `crm.company.fields`
- Дополнительный вызов `crm.enum.fields` не требуется, так как он работает только для смарт-процессов
- Возвращает только поля с непустыми значениями
- Включает детальное логирование для отладки

### Формат возвращаемых данных
```php
[
  'field_id' => [
    'name' => 'Название поля',
    'type' => 'enum',
    'values' => [
      'ID' => 'Название значения',
      ...
    ]
  ],
  ...
]
```

## Общая логика обработки

Все три метода выполняют следующие шаги:

1. **Получение полей** - Вызывают соответствующий API-метод Bitrix24 для получения всех полей сущности
2. **Фильтрация** - Фильтруют поля по типам: `enum`, `enumeration`, `list`, `crm_status`, `crm_category`
3. **Извлечение значений** - Извлекают значения из разных форматов ответа API:
   - `items` - массив значений (основной формат)
   - `options` - альтернативный формат
   - `values` - еще один вариант формата
4. **Структурирование** - Формируют структурированный массив с информацией о поле и его значениях
5. **Логирование** - Включают детальное логирование на каждом этапе для отладки

## Поддерживаемые типы полей

Все методы обрабатывают следующие типы полей:
- `enum` - Перечисление
- `enumeration` - Перечисление (альтернативное название)
- `list` - Список
- `crm_status` - Статус CRM
- `crm_category` - Категория CRM

## Обработка форматов ответа API

Методы поддерживают несколько форматов ответа от Bitrix24 API:

### Формат 1: items (массив объектов)
```php
'items' => [
  ['ID' => '1', 'VALUE' => 'Значение 1'],
  ['ID' => '2', 'VALUE' => 'Значение 2']
]
```

### Формат 2: items (простой массив)
```php
'items' => ['Значение 1', 'Значение 2']
```

### Формат 3: options (ассоциативный массив)
```php
'options' => [
  '1' => 'Значение 1',
  '2' => 'Значение 2'
]
```

### Формат 4: values (ассоциативный массив)
```php
'values' => [
  '1' => 'Значение 1',
  '2' => 'Значение 2'
]
```

## Различия между методами

| Метод | Параметры | Дополнительные API вызовы | Особенности |
|-------|-----------|---------------------------|-------------|
| `getSmartProcessListFields` | `$entityTypeId` (опциональный) | `crm.enum.fields` (при необходимости) | Единственный метод с параметром и дополнительной логикой |
| `getContactListFields` | Нет | Нет | Работает только с контактами |
| `getCompanyListFields` | Нет | Нет | Работает только с компаниями |

## Обработка ошибок

Все методы:
- Возвращают `false` при ошибке получения данных от API
- Логируют ошибки через `$this->logger->error()`
- Проверяют структуру ответа перед обработкой
- Включают детальное логирование для отладки

## Примеры использования

### Получение полей смарт-процесса
```php
// С ID из конфига
$fields = $api->getSmartProcessListFields();

// С явным указанием ID
$fields = $api->getSmartProcessListFields(123);
```

### Получение полей контакта
```php
$fields = $api->getContactListFields();
```

### Получение полей компании
```php
$fields = $api->getCompanyListFields();
```

### Обработка результата
```php
if ($fields !== false) {
    foreach ($fields as $fieldId => $fieldData) {
        echo "Поле: {$fieldData['name']}\n";
        echo "Тип: {$fieldData['type']}\n";
        echo "Значения:\n";
        foreach ($fieldData['values'] as $valueId => $valueName) {
            echo "  {$valueId}: {$valueName}\n";
        }
    }
} else {
    echo "Ошибка получения полей\n";
}
```







