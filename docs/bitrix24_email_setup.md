# Инструкция по настройке отправки почтовых сообщений через Bitrix24

## Обзор

Система использует метод `sendEmailToContact()` класса `Bitrix24API` для отправки почтовых сообщений контактам через API Bitrix24. Письма отправляются через метод `crm.activity.add` с типом активности "Письмо".

## Требования

1. **Настроенный webhook в Bitrix24** с правами на:
   - Чтение контактов (`crm.contact.get`)
   - Создание активностей (`crm.activity.add`)

2. **Настроенный почтовый сервер в Bitrix24** для отправки писем

3. **Email адрес у контакта** в Bitrix24

## Настройка Bitrix24

### Шаг 1: Настройка почтового сервера

1. Войдите в Bitrix24 как администратор
2. Перейдите в **Настройки** → **Почта** → **Почтовые серверы**
3. Нажмите **Добавить почтовый сервер**
4. Заполните параметры:
   - **Тип сервера**: SMTP
   - **Адрес сервера**: адрес SMTP сервера (например, `smtp.gmail.com`, `smtp.mail.ru`)
   - **Порт**: обычно 587 (TLS) или 465 (SSL)
   - **Шифрование**: TLS или SSL (в зависимости от порта)
   - **Логин**: email адрес для отправки
   - **Пароль**: пароль от email или пароль приложения
5. Нажмите **Сохранить**
6. Проверьте работу сервера, отправив тестовое письмо

**Важно**: 
- Для Gmail необходимо использовать пароль приложения, а не основной пароль
- Для Mail.ru может потребоваться включить SMTP в настройках почты
- Некоторые провайдеры требуют подтверждения отправителя

### Шаг 2: Проверка прав webhook

1. Перейдите в **Настройки** → **Разработчикам** → **Другое** → **Входящий webhook**
2. Найдите ваш webhook или создайте новый
3. Убедитесь, что webhook имеет права:
   - ✅ `crm` - доступ к CRM
   - ✅ `crm.contact` - работа с контактами
   - ✅ `crm.activity` - работа с активностями

4. Скопируйте URL webhook и добавьте в `.env` файл:
   ```
   BITRIX24_WEBHOOK_URL=https://ваш-портал.bitrix24.ru/rest/1/ваш-webhook/
   ```

### Шаг 3: Настройка адреса отправителя (опционально)

Если вы хотите указать конкретный адрес отправителя для писем из ЛК:

1. Откройте файл `src/config/bitrix24.php`
2. Добавьте в секцию `bitrix24`:
   ```php
   'email_from' => EnvLoader::get('BITRIX24_EMAIL_FROM', ''),
   ```
3. Добавьте в `.env` файл:
   ```
   BITRIX24_EMAIL_FROM=noreply@example.com
   ```

**Примечание**: Если `email_from` не указан, Bitrix24 будет использовать адрес отправителя по умолчанию (настроенный в почтовом сервере).

## Как работает отправка

### Процесс отправки письма

1. **Получение email адреса контакта**:
   - Сначала система пытается получить email из локального хранилища (LocalStorage)
   - Если email не найден, запрашивается из Bitrix24 через API
   - Email извлекается из массива Bitrix24 формата `[['VALUE' => 'email@example.com']]`

2. **Валидация email**:
   - Проверяется наличие и валидность email адреса
   - Если email невалиден или отсутствует, отправка прерывается с ошибкой

3. **Формирование активности**:
   - Создается активность типа "Письмо" (`TYPE_ID = 4`)
   - Указывается провайдер `crm_email`
   - Заполняются тема, текст (HTML), получатель
   - Устанавливается направление "Исходящее" (`DIRECTION = 2`)

4. **Отправка через API**:
   - Вызывается метод `crm.activity.add` с данными активности
   - Bitrix24 обрабатывает активность и отправляет письмо через настроенный почтовый сервер

### Формат сообщения

- **Тема**: обычный текст
- **Текст**: HTML формат (`DESCRIPTION_TYPE = 2`)
- Поддерживаются HTML теги: `<h1>`, `<h2>`, `<p>`, `<br>`, `<strong>`, `<em>`, и т.д.

## Тестирование

### Использование тестового скрипта

```bash
cd /var/www/efrolov-dev/html/application/lk/src/scripts
php test_send_email.php [contact_id] [subject] [message]
```

**Примеры:**

```bash
# Интерактивный режим
php test_send_email.php

# С параметрами
php test_send_email.php 3 "Тестовое письмо" "Это тестовое сообщение"

# Только с contact_id (тема и сообщение будут запрошены интерактивно)
php test_send_email.php 3
```

### Что проверяет скрипт

1. ✅ Наличие контакта в локальном хранилище
2. ✅ Наличие контакта в Bitrix24
3. ✅ Наличие email адреса у контакта
4. ✅ Настройку `email_from` (если задана)
5. ✅ Отправку письма через API
6. ✅ Результат отправки

### Проверка результата

После успешной отправки:

1. **В Bitrix24**:
   - Откройте карточку контакта
   - Перейдите на вкладку **Активности**
   - Найдите созданную активность типа "Письмо"
   - Проверьте тему и содержимое письма

2. **В почтовом ящике получателя**:
   - Проверьте входящие письма
   - Убедитесь, что письмо получено
   - Проверьте корректность отображения HTML

3. **В логах**:
   - Проверьте файл логов: `logs/bitrix24_webhooks.log`
   - Найдите записи с уровнем `INFO` и сообщением "Sending email via Bitrix24"

## Возможные проблемы и решения

### Проблема: Письмо не отправляется

**Причины:**
1. Не настроен почтовый сервер в Bitrix24
2. У контакта нет email адреса
3. Недостаточно прав у webhook
4. Неверные настройки SMTP сервера

**Решение:**
- Проверьте настройки почтового сервера в Bitrix24
- Убедитесь, что у контакта указан валидный email
- Проверьте права webhook
- Отправьте тестовое письмо из Bitrix24 вручную

### Проблема: Письмо отправляется, но не доставляется

**Причины:**
1. Письмо попадает в спам
2. Неверный адрес получателя
3. Проблемы с почтовым сервером получателя

**Решение:**
- Проверьте папку "Спам" у получателя
- Убедитесь в корректности email адреса
- Проверьте настройки SPF, DKIM, DMARC для домена отправителя

### Проблема: Ошибка "Invalid email not found for contact"

**Причина:** У контакта не указан email адрес или он невалиден

**Решение:**
- Добавьте email адрес контакту в Bitrix24
- Убедитесь, что email имеет правильный формат
- Проверьте, что email сохранен в поле `EMAIL` контакта

### Проблема: Письмо отправляется, но отображается неправильно

**Причина:** Проблемы с HTML форматированием

**Решение:**
- Используйте валидный HTML
- Избегайте сложных CSS стилей
- Тестируйте на разных почтовых клиентах

## Дополнительная информация

### API метод

Метод использует API Bitrix24: `crm.activity.add`

**Параметры активности:**
- `OWNER_TYPE_ID`: 3 (контакт)
- `TYPE_ID`: 4 (письмо)
- `PROVIDER_ID`: `crm_email`
- `PROVIDER_TYPE_ID`: `EMAIL`
- `DESCRIPTION_TYPE`: 2 (HTML)
- `DIRECTION`: 2 (исходящее)

### Логирование

Все операции логируются в файл, указанный в конфигурации:
- Успешная отправка: уровень `INFO`
- Ошибки: уровень `ERROR`
- Детали запроса: уровень `DEBUG`

### Безопасность

- Email адреса валидируются перед отправкой
- Webhook должен быть защищен токеном (если настроен)
- Рекомендуется использовать HTTPS для webhook URL

## Примеры использования в коде

```php
// Базовый пример
$result = $bitrixAPI->sendEmailToContact(
    $contactId,
    'Тема письма',
    '<p>Текст письма в HTML формате</p>',
    $localStorage
);

// С проверкой результата
if ($result && isset($result['result'])) {
    $activityId = $result['result'];
    echo "Письмо отправлено, Activity ID: {$activityId}";
} else {
    echo "Ошибка отправки письма";
}
```

## Поддержка

При возникновении проблем:
1. Проверьте логи в `logs/bitrix24_webhooks.log`
2. Запустите тестовый скрипт для диагностики
3. Проверьте настройки в Bitrix24
4. Убедитесь, что почтовый сервер работает корректно

