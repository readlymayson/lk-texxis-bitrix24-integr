# Инструкция по настройке отправки почтовых сообщений через Bitrix24

## Обзор

Система использует метод `startEmailBusinessProcess()` класса `Bitrix24API` для запуска бизнес-процесса отправки почтовых сообщений контактам через API Bitrix24. Бизнес-процесс запускается через метод `bizproc.workflow.start`.

## Требования

1. **Настроенный webhook в Bitrix24** с правами на:
   - Чтение контактов (`crm.contact.get`)
   - Запуск бизнес-процессов (`bizproc.workflow.start`)

2. **Созданный бизнес-процесс в Bitrix24** для отправки email контактам

3. **Настроенный почтовый сервер в Bitrix24** для отправки писем (настраивается в бизнес-процессе)

4. **Email адрес у контакта** в Bitrix24

## Настройка Bitrix24

### Шаг 1: Создание бизнес-процесса для отправки email

1. Войдите в Bitrix24 как администратор
2. Перейдите в **CRM** → **Настройки** → **Бизнес-процессы**
3. Создайте новый бизнес-процесс для контактов
4. Настройте бизнес-процесс для отправки email:
   - Добавьте действие "Отправить письмо"
   - Настройте параметры письма (тема, текст)
   - Используйте переменную `URL` из параметров процесса
5. Сохраните бизнес-процесс и скопируйте его ID

**Важно**: Бизнес-процесс должен быть настроен для работы с документами типа "Контакт" (`CCrmDocumentContact`).

### Шаг 2: Настройка почтового сервера

1. Войдите в Bitrix24 как администратор
2. Перейдите в **Настройки** → **Почта** → **Почтовые серверы**
3. Нажмите **Добавить почтовый сервер**
4. Заполните параметры:
   - **Тип сервера**: SMTP
   - **Адрес сервера**: адрес SMTP сервера (например, `smtp.gmail.com`, `smtp.mail.ru`)
   - **Порт**: обычно 587 (TLS) или 465 (SSL)
   - **Шифрование**: TLS или SSL (в зависимости от порта)
   - **Логин**: email адрес для отправки
   - **Пароль**: пароль от email или пароль приложения
5. Нажмите **Сохранить**
6. Проверьте работу сервера, отправив тестовое письмо

**Важно**: 
- Для Gmail необходимо использовать пароль приложения, а не основной пароль
- Для Mail.ru может потребоваться включить SMTP в настройках почты
- Некоторые провайдеры требуют подтверждения отправителя

### Шаг 3: Проверка прав webhook

1. Перейдите в **Настройки** → **Разработчикам** → **Другое** → **Входящий webhook**
2. Найдите ваш webhook или создайте новый
3. Убедитесь, что webhook имеет права:
   - ✅ `crm` - доступ к CRM
   - ✅ `crm.contact` - работа с контактами
   - ✅ `bizproc` - работа с бизнес-процессами

4. Скопируйте URL webhook и добавьте в `.env` файл:
   ```
   BITRIX24_WEBHOOK_URL=https://ваш-портал.bitrix24.ru/rest/1/ваш-webhook/
   ```

### Шаг 4: Настройка ID бизнес-процесса

1. Откройте файл `src/config/bitrix24.php`
2. Найдите секцию `bitrix24` и установите ID бизнес-процесса:
   ```php
   'email_business_process_id' => 123, // Замените на реальный ID вашего бизнес-процесса
   ```
3. Аналогично обновите файл `src/config/bitrix24_copy.php` (если используется)

**Важно**: ID бизнес-процесса можно найти в настройках бизнес-процесса в Bitrix24 или в URL при редактировании процесса.

## Как работает отправка

### Процесс запуска бизнес-процесса

1. **Валидация параметров**:
   - Проверяется наличие и валидность `contactId`
   - Проверяется наличие и валидность `url`
   - Проверяется наличие ID бизнес-процесса в конфигурации

2. **Запуск бизнес-процесса**:
   - Формируется запрос к API Bitrix24 с методом `bizproc.workflow.start`
   - Передаются параметры:
     - `templateId` - ID бизнес-процесса из конфигурации
     - `documentType` - тип документа: `['crm', 'CCrmDocumentContact', 'CONTACT']`
     - `documentId` - ID контакта
     - `parameters` - массив параметров с ключом `url`

3. **Обработка бизнес-процессом**:
   - Bitrix24 запускает бизнес-процесс для указанного контакта
   - Бизнес-процесс использует переданный параметр `url`
   - Бизнес-процесс отправляет письмо согласно своей настройке

### Параметры метода

- **contactId** (обязательный) - ID контакта в Bitrix24
- **url** (обязательный) - строка URL для передачи в бизнес-процесс

## Тестирование

### Использование тестового скрипта

```bash
cd /var/www/efrolov-dev/html/application/lk/src/scripts
php test_send_email.php [contact_id] [url]
```

**Примеры:**

```bash
# Интерактивный режим
php test_send_email.php

# С параметрами
php test_send_email.php 3 "https://example.com/link"

# Только с contact_id (url будет запрошен интерактивно)
php test_send_email.php 3
```

### Что проверяет скрипт

1. ✅ Наличие контакта в Bitrix24
2. ✅ Настройку `email_business_process_id` в конфигурации
3. ✅ Запуск бизнес-процесса через API
4. ✅ Результат запуска бизнес-процесса

### Проверка результата

После успешного запуска бизнес-процесса:

1. **В Bitrix24**:
   - Откройте карточку контакта
   - Перейдите на вкладку **Бизнес-процессы** или **Активности**
   - Найдите запущенный бизнес-процесс
   - Проверьте, что процесс выполнился успешно

2. **В почтовом ящике получателя**:
   - Проверьте входящие письма
   - Убедитесь, что письмо получено
   - Проверьте корректность отображения содержимого

3. **В логах**:
   - Проверьте файл логов: `logs/bitrix24_webhooks.log`
   - Найдите записи с уровнем `INFO` и сообщением "Starting email business process via Bitrix24"

## Возможные проблемы и решения

### Проблема: Бизнес-процесс не запускается

**Причины:**
1. Неверный ID бизнес-процесса в конфигурации
2. Бизнес-процесс не настроен для работы с контактами
3. Недостаточно прав у webhook для запуска бизнес-процессов
4. Неверный формат параметров

**Решение:**
- Проверьте ID бизнес-процесса в конфигурации
- Убедитесь, что бизнес-процесс настроен для документов типа "Контакт"
- Проверьте права webhook (должен быть доступ к `bizproc`)
- Проверьте логи для деталей ошибки

### Проблема: Письмо отправляется, но не доставляется

**Причины:**
1. Письмо попадает в спам
2. Неверный адрес получателя
3. Проблемы с почтовым сервером получателя

**Решение:**
- Проверьте папку "Спам" у получателя
- Убедитесь в корректности email адреса
- Проверьте настройки SPF, DKIM, DMARC для домена отправителя

### Проблема: Ошибка "Email business process ID is not configured"

**Причина:** ID бизнес-процесса не настроен в конфигурации

**Решение:**
- Откройте файл `src/config/bitrix24.php`
- Установите правильный ID бизнес-процесса в поле `email_business_process_id`
- Убедитесь, что ID соответствует реальному бизнес-процессу в Bitrix24

### Проблема: Бизнес-процесс запускается, но письмо не отправляется

**Причины:**
1. Не настроен почтовый сервер в Bitrix24
2. Бизнес-процесс не настроен для отправки email
3. У контакта нет email адреса

**Решение:**
- Проверьте настройки почтового сервера в Bitrix24
- Убедитесь, что в бизнес-процессе есть действие "Отправить письмо"
- Проверьте, что у контакта указан валидный email адрес

## Дополнительная информация

### API метод

Метод использует API Bitrix24: `bizproc.workflow.start`

**Параметры запроса:**
- `templateId` - ID бизнес-процесса (из конфигурации)
- `documentType` - тип документа: `['crm', 'CCrmDocumentContact', 'CONTACT']`
- `documentId` - ID контакта
- `parameters` - массив параметров с ключом `url`

### Логирование

Все операции логируются в файл, указанный в конфигурации:
- Успешный запуск бизнес-процесса: уровень `INFO`
- Ошибки: уровень `ERROR`
- Детали запроса: уровень `DEBUG`

### Безопасность

- Параметры валидируются перед запуском бизнес-процесса
- Webhook должен быть защищен токеном (если настроен)
- Рекомендуется использовать HTTPS для webhook URL
- URL передается в бизнес-процесс как есть, убедитесь в его валидности

## Примеры использования в коде

```php
// Базовый пример
$result = $bitrixAPI->startEmailBusinessProcess(
    $contactId,
    'https://example.com/link'
);

// С проверкой результата
if ($result && isset($result['result'])) {
    $workflowId = $result['result'];
    echo "Бизнес-процесс запущен, Workflow ID: {$workflowId}";
} else {
    echo "Ошибка запуска бизнес-процесса";
}
```

## Поддержка

При возникновении проблем:
1. Проверьте логи в `logs/bitrix24_webhooks.log`
2. Запустите тестовый скрипт для диагностики
3. Проверьте настройки в Bitrix24
4. Убедитесь, что почтовый сервер работает корректно

