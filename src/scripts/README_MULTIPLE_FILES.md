# Тестирование webhook и проектов

## Обзор

В директории `src/scripts/` находятся тестовые скрипты для проверки различных функций интеграции с Bitrix24:

### Базовые тесты
- `test_project_creation.php` - создание проектов с прикреплением файлов
- `test_project_deletion.php` - тестирование удаления проектов через webhook
- `test_webhook.php` - отправка тестовых webhook запросов
- `test_webhook_simple.php` - веб-интерфейс для тестирования webhook
- `test_sync.php` - тестирование синхронизации данных контактов
- `test_smart_process_cards.php` - тестирование создания карточек смарт-процессов
- `test_smart_process_mapping.php` - тестирование маппинга полей смарт-процессов
- `test_uf_codes_validation.php` - тестирование валидации UF кодов полей

### Специализированные тесты
- `test_file_upload.php` - тестирование загрузки файлов в Bitrix24
- `test_send_email.php` - тестирование отправки email через бизнес-процессы

### Тесты качества и безопасности
- `test_error_handling.php` - тестирование обработки различных типов ошибок
- `test_performance.php` - тестирование производительности системы
- `test_security.php` - тестирование безопасности и защита от уязвимостей

### Утилиты
- `run_all_tests.php` - запуск всех тестов с отчетом

## Тестирование удаления проектов

Скрипт `test_project_deletion.php` позволяет протестировать удаление проектов через webhook событие `ONCRMDYNAMICITEMDELETE`.

### Использование

```bash
php test_project_deletion.php [project_id]
```

### Параметры

- `project_id`: ID проекта для удаления.
  - Если не указан: создается тестовый проект с ID=999999 и затем удаляется
  - Если указан: удаляется существующий проект с указанным ID

### Примеры

```bash
# Создать и удалить тестовый проект с ID=999999
php test_project_deletion.php

# Удалить существующий проект с ID=123
php test_project_deletion.php 123
```

### Что делает скрипт

1. **Создание тестового проекта** (только если project_id не указан)
   - Создает проект с ID=999999 и тестовыми данными в локальном хранилище
   - Проверяет успешность создания

2. **Проверка наличия проекта**
   - Проверяет наличие проекта в локальном хранилище перед удалением
   - Если проект не найден и это существующий проект - тест продолжается

3. **Отправка webhook запроса**
   - Отправляет POST запрос с событием `ONCRMDYNAMICITEMDELETE`
   - Проверяет успешность обработки webhook

4. **Проверка удаления**
   - Проверяет, что проект был удален из локального хранилища
   - Учитывает случаи, когда проект изначально отсутствовал

### Проверка результата

После выполнения скрипта:

1. Должен быть выведен отчет с результатами каждого шага
2. Проверьте логи в файле: `src/logs/bitrix24_webhooks.log`
3. При успешном тесте должно быть сообщение "=== ТЕСТ ПРОШЕЛ УСПЕШНО ==="
4. Проект должен исчезнуть из локального хранилища JSON файлов

## Тестирование создания проектов

1. Создает тестовый проект в локальном хранилище (если не указан --no-create)
2. Проверяет наличие проекта
3. Отправляет webhook запрос с событием `ONCRMDYNAMICITEMDELETE`
4. Проверяет, что проект был удален из локального хранилища

## Тестирование создания проектов

Скрипт `test_project_creation.php` поддерживает создание проектов с прикреплением нескольких файлов к полю `equipment_list`. Проекты автоматически получают `company_id` из данных связанного контакта.

## Использование

### 1. Создание проекта с одним файлом (автоматическая загрузка)

```bash
php test_project_creation.php 3
```

Будет использован тестовый файл `test_equipment_list.txt` из директории скрипта.

### 2. Создание проекта с несколькими существующими файлами по ID

```bash
php test_project_creation.php 3 123 456 789
```

Прикрепит к проекту файлы с ID 123, 456 и 789 из Bitrix24.

### 3. Создание проекта с загрузкой нескольких новых файлов

```bash
php test_project_creation.php 3 --files test_equipment_list.txt test_equipment_list_2.txt test_equipment_list_3.txt
```

Загрузит указанные файлы в Bitrix24 и прикрепит их к проекту.

### 4. Комбинированный вариант (существующие + новые файлы)

Сначала загрузите файлы и получите их ID, затем используйте их:

```bash
# Загружаем файлы отдельно и получаем ID
# Затем используем ID
php test_project_creation.php 3 123 456 --files test_equipment_list_3.txt
```

## Доступные тестовые файлы

В директории `src/scripts/` доступны следующие тестовые файлы:

- `test_equipment_list.txt` - основной тестовый файл (используется по умолчанию)
- `test_equipment_list_2.txt` - дополнительный тестовый файл
- `test_equipment_list_3.txt` - дополнительный тестовый файл

## Примеры команд

### Пример 1: Тест с 3 файлами
```bash
cd /var/www/efrolov-dev/html/application/lk/src/scripts
php test_project_creation.php 3 --files test_equipment_list.txt test_equipment_list_2.txt test_equipment_list_3.txt
```

### Пример 2: Тест с существующими файлами
```bash
# Предположим, что файлы уже загружены в Bitrix24 с ID 100, 101, 102
php test_project_creation.php 3 100 101 102
```

### Пример 3: Интерактивный режим
```bash
php test_project_creation.php
# Скрипт попросит ввести Contact ID
```

## Проверка результата

После выполнения скрипта:

1. Проверьте вывод скрипта - должно быть сообщение об успешном создании проекта
2. Проверьте логи в файле: `src/logs/bitrix24_webhooks.log`
3. Проверьте созданный проект в Bitrix24 - поле "Перечень оборудования" должно содержать все прикрепленные файлы
4. Проверьте отображение в личном кабинете - все файлы должны отображаться в таблице проектов

## Примечания

- Если файл не найден по указанному пути, скрипт выведет предупреждение и пропустит этот файл
- Если не указаны ни file_id, ни --files, будет использован тестовый файл `test_equipment_list.txt`
- Все файлы должны существовать и быть доступны для чтения
- Убедитесь, что у webhook есть права на загрузку файлов (disk) в Bitrix24

## Другие тестовые скрипты

### test_webhook.php
Отправка тестовых webhook запросов различных типов через командную строку.

```bash
php test_webhook.php ONCRMDYNAMICITEMDELETE 123
```

### test_webhook_simple.php
Веб-интерфейс для тестирования webhook через браузер.

```
https://efrolov-dev.ru/application/lk/src/scripts/test_webhook_simple.php
```

Поддерживает выбор типа события и параметров через форму.

## Тестирование обработки ошибок

Скрипт `test_error_handling.php` проверяет корректную обработку различных типов ошибок:

- Недействительные URL webhook
- Сетевые ошибки и таймауты
- Ошибки валидации данных webhook
- Ошибки файловой системы

### Использование

```bash
php test_error_handling.php [test_type]
```

### Параметры

- `test_type`: тип теста
  - `invalid_webhook` - тест недействительного webhook URL
  - `network_error` - тест сетевых ошибок
  - `validation_error` - тест ошибок валидации
  - `file_error` - тест ошибок файловой системы
  - `all` - запустить все тесты (по умолчанию)

### Примеры

```bash
# Запустить все тесты обработки ошибок
php test_error_handling.php all

# Проверить только ошибки валидации
php test_error_handling.php validation_error
```

## Тестирование производительности

Скрипт `test_performance.php` измеряет производительность ключевых операций системы:

- Чтение/запись в локальное хранилище JSON
- API запросы к Bitrix24
- Загрузка файлов
- Обработка JSON данных

### Использование

```bash
php test_performance.php [operation] [iterations]
```

### Параметры

- `operation`: операция для тестирования
  - `local_storage` - тестирование локального хранилища
  - `api_call` - тестирование API вызовов
  - `file_upload` - тестирование загрузки файлов
  - `json_processing` - тестирование обработки JSON
  - `all` - все операции (по умолчанию)
- `iterations`: количество итераций (по умолчанию 10)

### Примеры

```bash
# Полное тестирование производительности
php test_performance.php all 20

# Тестирование только локального хранилища
php test_performance.php local_storage 100
```

## Тестирование безопасности

Скрипт `test_security.php` проверяет защиту системы от распространенных уязвимостей:

- XSS атаки
- SQL и command инъекции
- Path traversal атаки
- Проблемы авторизации
- Валидация входных данных

### Использование

```bash
php test_security.php [test_type]
```

### Параметры

- `test_type`: тип теста безопасности
  - `xss` - тестирование XSS атак
  - `injection` - тестирование инъекций
  - `path_traversal` - тестирование path traversal
  - `auth` - тестирование авторизации
  - `data_validation` - тестирование валидации данных
  - `all` - все тесты безопасности (по умолчанию)

### Примеры

```bash
# Полное тестирование безопасности
php test_security.php all

# Проверка только XSS уязвимостей
php test_security.php xss
```

⚠️ **Внимание**: Тесты безопасности могут генерировать потенциально опасные данные. Запускайте только в тестовой среде!

## Запуск всех тестов

Скрипт `run_all_tests.php` позволяет запускать все тесты интеграции в правильном порядке с подробным отчетом.

### Использование

```bash
php run_all_tests.php [test_suite]
```

### Параметры

- `test_suite`: набор тестов для запуска
  - `all` - все доступные тесты (по умолчанию)
  - `basic` - базовые тесты (webhook, sync, projects)
  - `security` - тесты безопасности
  - `performance` - тесты производительности
  - `errors` - тесты обработки ошибок
  - `files` - тесты файловых операций
  - `email` - тесты отправки email

### Примеры

```bash
# Запустить все тесты
php run_all_tests.php all

# Запустить только базовые тесты
php run_all_tests.php basic

# Запустить тесты безопасности и производительности
php run_all_tests.php security
php run_all_tests.php performance
```

